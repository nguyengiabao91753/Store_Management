@model RetailShop.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "_Layout";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.lordicon.com/lordicon.js"></script>

<style>
    body {
        background-color: #f4f7fa;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    }

    .stat-box {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s;
    }

    .stat-box:hover {
        transform: translateY(-3px);
    }

    .progress {
        height: 8px;
        border-radius: 5px;
    }
</style>

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">Dashboard</h3>
        <small class="text-muted">Home / Dashboard</small>
    </div>

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stat-box">
                <div>
                    <h6 class="text-uppercase text-muted mb-1">Revenue (Monthly)</h6>
                    <h3>
                        @if (Model.MonthlyRevenue.Any())
                        {
                            var lastMonth = Model.MonthlyRevenue.Last();
                            @(string.Format("{0:N0}", lastMonth.Total) + " VND")
                        }
                        else
                        {

                            @("0 VND")
                        }
                    </h3>
                    <small class="text-success">Since last month</small>
                </div>
                <div class="icon bg-primary bg-opacity-10 p-3 rounded">
                    <script src="https://cdn.lordicon.com/lordicon.js"></script>
                    <lord-icon src="https://cdn.lordicon.com/kkdnopsh.json" trigger="loop" delay="1500" stroke="bold"
                        state="in-reveal" style="width:45px;height:45px">
                    </lord-icon>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div>
                    <h6 class="text-uppercase text-muted mb-1">Sales</h6>
                    <h3>@Model.TopProducts.Sum(p => p.QuantitySold)</h3>
                    <small class="text-success">↑ Active Sales</small>
                </div>
                <div class="icon bg-success bg-opacity-10 p-3 rounded">
                    <script src="https://cdn.lordicon.com/lordicon.js"></script>
                    <lord-icon src="https://cdn.lordicon.com/hwpohgdf.json" trigger="loop" delay="2000" stroke="bold"
                        colors="primary:#66a1ee,secondary:#ebe6ef,tertiary:#e4e4e4" style="width:45px;height:45px">
                    </lord-icon>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div>
                    <h6 class="text-uppercase text-muted mb-1">New Users</h6>
                    <h3>366</h3>
                    <small class="text-success">↑ 20.4%</small>
                </div>
                <div class="icon bg-info bg-opacity-10 p-3 rounded">
                    <script src="https://cdn.lordicon.com/lordicon.js"></script>
                    <lord-icon src="https://cdn.lordicon.com/xjkryxnf.json" trigger="loop" delay="1000" stroke="bold"
                        state="morph-coin"
                        colors="primary:#000000,secondary:#4bb3fd,tertiary:#ffc738,quaternary:#ebe6ef"
                        style="width:45px;height:45px">
                    </lord-icon>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-box">
                <div>
                    <h6 class="text-uppercase text-muted mb-1">Profit Overview</h6>
                    <h3>20000</h3>
                    <small class="text-danger">↓ 1.10%</small>
                </div>
                <div class="icon bg-warning bg-opacity-10 p-3 rounded">
                    <script src="https://cdn.lordicon.com/lordicon.js"></script>
                    <lord-icon src="https://cdn.lordicon.com/fcwmlcjj.json" trigger="loop" stroke="bold"
                        state="loop-all" colors="primary:#000000,secondary:#f24c00,tertiary:#f28ba8,quaternary:#ffc738"
                        style="width:45px;height:45px">
                    </lord-icon>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart + Top products -->
    <div class="row g-3 mb-4">
        <div class="col-lg-8">
            <div class="card p-3">
                <h5 class="fw-bold mb-3 text-primary">Monthly Revenue</h5>
                <canvas id="revenueChart" height="150"></canvas>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card p-3">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0 text-primary">Top Selling Products</h6>
                    <div class="d-flex gap-2">
                        <select id="monthFilter" class="form-select form-select-sm w-auto">
                            <option value="0">All Months</option>
                            @for (int m = 1; m <= 12; m++)
                            {
                                <option value="@m">Month @m</option>
                            }
                        </select>
                        <select id="yearFilter" class="form-select form-select-sm w-auto">
                            <option value="0">All Years</option>
                            @foreach (var y in Model.TopProducts.Select(p => p.Year).Distinct())
                            {
                                <option value="@y">@y</option>
                            }
                        </select>
                    </div>
                </div>
                <div id="productList"></div>
            </div>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold text-primary mb-0">Order List</h5>
            <div class="d-flex gap-2">
                <input type="date" id="startDate" class="form-control form-control-sm" />
                <input type="date" id="endDate" class="form-control form-control-sm" />
            </div>
        </div>
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="orderTableBody"></tbody>
        </table>
        <div class="d-flex justify-content-end mt-3">
            <nav>
                <ul id="pagination" class="pagination pagination-sm mb-0"></ul>
            </nav>
        </div>
    </div>
</div>

<script>
    const revenueData = @Html.Raw(Json.Serialize(Model.MonthlyRevenue));
    const topProducts = @Html.Raw(Json.Serialize(Model.TopProducts));

    // === Chart Revenue ===
    new Chart(document.getElementById('revenueChart'), {
        type: 'line',
        data: {
            labels: revenueData.map(r => r.month + '/' + r.year),
            datasets: [{
                label: 'Revenue',
                data: revenueData.map(r => r.total),
                fill: true,
                backgroundColor: 'rgba(99, 132, 255, 0.2)',
                borderColor: 'rgba(99, 132, 255, 1)',
                tension: 0.4
            }]
        },
        options: {
            plugins: { legend: { display: false } },
            scales: { y: { ticks: { callback: v => v.toLocaleString() + ' VND' } } }
        }
    });

    // === Top Products Filter ===
    const productList = document.getElementById("productList");
    const monthFilter = document.getElementById("monthFilter");
    const yearFilter = document.getElementById("yearFilter");

    function renderProducts(data) {
        if (!data.length) {
            productList.innerHTML = "<p class='text-muted'>No sales data available.</p>";
            return;
        }
        const maxSold = Math.max(...data.map(p => p.quantitySold));
        productList.innerHTML = data.map(p => `
            <div class="mb-2">
                <small>${p.productName}</small>
                <div class="progress">
                    <div class="progress-bar bg-primary" style="width:${(p.quantitySold / maxSold) * 100}%"></div>
                </div>
                <small class="text-muted">${p.quantitySold} items sold (${p.month}/${p.year})</small>
            </div>
        `).join('');
    }

    function applyProductFilter() {
        const m = +monthFilter.value, y = +yearFilter.value;
        const filtered = topProducts.filter(p =>
            (m === 0 || p.month === m) && (y === 0 || p.year === y)
        );
        renderProducts(filtered);
    }

    monthFilter.addEventListener("change", applyProductFilter);
    yearFilter.addEventListener("change", applyProductFilter);
    renderProducts(topProducts);

    // === Orders Table via API ===
    const orderBody = document.getElementById("orderTableBody");
    const startDate = document.getElementById("startDate");
    const endDate = document.getElementById("endDate");
    let currentPage = 1, pageSize = 10;

    const today = new Date().toISOString().split("T")[0];
    startDate.value = today;
    endDate.value = today;

    async function loadOrders(page = 1) {
        currentPage = page;
        const params = new URLSearchParams({
            pageIndex: page,
            pageSize: pageSize,
            startDate: startDate.value || "",
            endDate: endDate.value || "",
            month: "",
            year: ""
        });
        const res = await fetch(`/Dashboard/GetOrders?${params.toString()}`);
        const result = await res.json();
        renderOrders(result.data);
        renderPagination(result.totalPages, result.currentPage);
    }

    function renderOrders(data) {
        if (!data.length) {
            orderBody.innerHTML = "<tr><td colspan='5' class='text-center text-muted'>No orders found</td></tr>";
            return;
        }
        orderBody.innerHTML = data.map(o => `
            <tr>
                <td>${o.orderId}</td>
                <td>${o.customerName ?? "N/A"}</td>
                <td>${o.totalAmount.toLocaleString()} VND</td>
                <td><span class="badge bg-${o.status === "paid" ? "success" : (o.status === "pending" ? "warning" : "danger")}">${o.status}</span></td>
                <td>${new Date(o.orderDate).toLocaleDateString()}</td>
            </tr>
        `).join('');
    }

    function renderPagination(totalPages, currentPage) {
        const pagination = document.getElementById("pagination");
        if (totalPages <= 1) { pagination.innerHTML = ""; return; }
        let html = "";
        for (let i = 1; i <= totalPages; i++) {
            html += `<li class="page-item ${i === currentPage ? "active" : ""}">
                        <a class="page-link" href="#" onclick="loadOrders(${i})">${i}</a>
                     </li>`;
        }
        pagination.innerHTML = html;
    }

    [monthOrderFilter, yearOrderFilter, startDate, endDate].forEach(el =>
        el.addEventListener("change", () => loadOrders(1))
    );

    loadOrders();
</script>