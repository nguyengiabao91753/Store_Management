@page "/checkout"
@using RetailShop.Blazor.Components.Shared
@rendermode InteractiveServer

@inject NavigationManager Nav

<PageTitle>Checkout - MockStore</PageTitle>

<div class="checkout-container">
    <div class="checkout-content">
        <div class="checkout-main">
            <div class="checkout-header">
                <h1>Checkout</h1>
                <div class="breadcrumb">
                    <a href="/cart">Cart</a>
                    <span class="separator">›</span>
                    <span class="active">Checkout</span>
                </div>
            </div>

            <!-- Customer Information -->
            <div class="checkout-section">
                <div class="section-title">
                    <div class="title-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <h2>Contact Information</h2>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="customerName">Full Name *</label>
                        <input type="text" 
                               id="customerName" 
                               @bind="orderDto.CustomerName" 
                               placeholder="Enter your full name"
                               class="form-input" />
                        @if (showValidation && string.IsNullOrWhiteSpace(orderDto.CustomerName))
                        {
                            <span class="error-message">Name is required</span>
                        }
                    </div>
                    <div class="form-group">
                        <label for="customerPhone">Phone Number *</label>
                        <input type="tel" 
                               id="customerPhone" 
                               @bind="orderDto.CustomerPhone" 
                               placeholder="Enter your phone number"
                               class="form-input" />
                        @if (showValidation && string.IsNullOrWhiteSpace(orderDto.CustomerPhone))
                        {
                            <span class="error-message">Phone is required</span>
                        }
                    </div>
                </div>
            </div>

            <!-- Payment Method -->
            <div class="checkout-section">
                <div class="section-title">
                    <div class="title-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                            <line x1="1" y1="10" x2="23" y2="10"/>
                        </svg>
                    </div>
                    <h2>Payment Method</h2>
                </div>
                <div class="payment-methods">
                    <div class="payment-option @(orderDto.PaymentMethod == "cash" ? "active" : "")"
                         @onclick='() => SelectPaymentMethod("cash")'>
                        <div class="payment-radio">
                            <div class="radio-dot"></div>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Cash on Delivery</div>
                            <div class="payment-desc">Pay when you receive</div>
                        </div>
                        <div class="payment-icon">💵</div>
                    </div>
                    <div class="payment-option @(orderDto.PaymentMethod == "card" ? "active" : "")"
                         @onclick='() => SelectPaymentMethod("card")'>
                        <div class="payment-radio">
                            <div class="radio-dot"></div>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Credit/Debit Card</div>
                            <div class="payment-desc">Visa, Mastercard accepted</div>
                        </div>
                        <div class="payment-icon">💳</div>
                    </div>
                    <div class="payment-option @(orderDto.PaymentMethod == "bank_transfer" ? "active" : "")"
                         @onclick='() => SelectPaymentMethod("bank_transfer")'>
                        <div class="payment-radio">
                            <div class="radio-dot"></div>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">Bank Transfer</div>
                            <div class="payment-desc">Direct bank payment</div>
                        </div>
                        <div class="payment-icon">🏦</div>
                    </div>

                    <div class="payment-option @(orderDto.PaymentMethod == "e-wallet" ? "active" : "")"
                         @onclick='() => SelectPaymentMethod("e-wallet")'>
                        <div class="payment-radio">
                            <div class="radio-dot"></div>
                        </div>
                        <div class="payment-info">
                            <div class="payment-name">E-Wallet</div>
                            <div class="payment-desc">PayPal and digital wallets</div>
                        </div>
                        <div class="payment-icon">💰</div>
                    </div>

                    @if (orderDto.PaymentMethod == "e-wallet")
                    {
                        <div class="ewallet-options" style="margin-top: 20px; padding: 20px; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <div class="ewallet-title" style="font-size: 14px; font-weight: 600; color: #0f172a; margin-bottom: 16px;">Select e-wallet Provider</div>
                            <div class="ewallet-providers" style="display: flex; flex-direction: column; gap: 12px;">
                                <!-- PayPal provider with inline styles -->
                                <div class="ewallet-provider @(selectedEWallet == "PayPal" ? "selected" : "")"
                                     @onclick='() => SelectEWallet("PayPal")'
                                     style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid @(selectedEWallet == "PayPal" ? "#2563eb" : "#e2e8f0"); border-radius: 12px; cursor: pointer; transition: all 0.2s ease; position: relative;">
                                    <svg class="provider-check" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"
                                         style="position: absolute; top: 12px; left: 12px; opacity: @(selectedEWallet == "PayPal" ? "1" : "0"); color: #2563eb; transition: opacity 0.2s ease;">
                                        <polyline points="20 6 9 17 4 12" />
                                    </svg>
                                    <div class="provider-logo" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; margin-left: 20px;">
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="#003087">
                                            <path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.023.143-.047.288-.077.437-.983 5.05-4.349 6.797-8.647 6.797h-2.19c-.524 0-.968.382-1.05.9l-1.12 7.106zm14.146-14.42c-.043.282-.088.57-.142.87-1.283 6.59-5.69 8.86-11.31 8.86H8.235l-2.126 13.477c-.068.45.27.863.726.863h5.134c.458 0 .848-.334.92-.787l.038-.195 1.14-7.23.073-.395c.073-.453.463-.787.92-.787h.58c3.76 0 6.705-1.528 7.565-5.946.36-1.847.174-3.388-.777-4.47-.283-.32-.634-.59-1.035-.807z" />
                                        </svg>
                                    </div>
                                    <div class="provider-info" style="flex: 1;">
                                        <div class="provider-name" style="font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">PayPal</div>
                                        <div class="provider-desc" style="font-size: 14px; color: #64748b;">Safe and fast payment</div>
                                    </div>
                                </div>

                                <!-- Apple Pay with inline styles -->
                                <div class="ewallet-provider disabled"
                                     style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; opacity: 0.5; cursor: not-allowed; position: relative;">
                                    <div class="provider-logo" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; margin-left: 20px; position: relative;">
                                        <div class="coming-soon-badge" style="position: absolute; top: -8px; right: -8px; background: #f97316; color: white; font-size: 9px; font-weight: 700; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Soon</div>
                                        <svg width="32" height="32" viewBox="0 0 24 24" fill="#000000">
                                            <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z" />
                                        </svg>
                                    </div>
                                    <div class="provider-info" style="flex: 1;">
                                        <div class="provider-name" style="font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">Apple Pay</div>
                                        <div class="provider-desc" style="font-size: 14px; color: #64748b;">Available soon</div>
                                    </div>
                                </div>

                                <!-- Google Pay with inline styles -->
                                <div class="ewallet-provider disabled"
                                     style="display: flex; align-items: center; gap: 16px; padding: 16px; background: white; border: 2px solid #e2e8f0; border-radius: 12px; opacity: 0.5; cursor: not-allowed; position: relative;">
                                    <div class="provider-logo" style="width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: #f8fafc; border-radius: 8px; margin-left: 20px; position: relative;">
                                        <div class="coming-soon-badge" style="position: absolute; top: -8px; right: -8px; background: #f97316; color: white; font-size: 9px; font-weight: 700; padding: 3px 6px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Soon</div>
                                        <svg width="32" height="32" viewBox="0 0 24 24">
                                            <path fill="#4285F4" d="M12.48 10.92v3.28h7.84c-.24 1.84-.853 3.187-1.787 4.133-1.147 1.147-2.933 2.4-6.053 2.4-4.827 0-8.6-3.893-8.6-8.72s3.773-8.72 8.6-8.72c2.6 0 4.507 1.027 5.907 2.347l2.307-2.307C18.747 1.44 16.133 0 12.48 0 5.867 0 .307 5.387.307 12s5.56 12 12.173 12c3.573 0 6.267-1.173 8.373-3.36 2.16-2.16 2.84-5.213 2.84-7.667 0-.76-.053-1.467-.173-2.053H12.48z" />
                                        </svg>
                                    </div>
                                    <div class="provider-info" style="flex: 1;">
                                        <div class="provider-name" style="font-size: 16px; font-weight: 600; color: #0f172a; margin-bottom: 4px;">Google Pay</div>
                                        <div class="provider-desc" style="font-size: 14px; color: #64748b;">Available soon</div>
                                    </div>
                                </div>
                            </div>

                            @if (!string.IsNullOrEmpty(selectedEWallet))
                            {
                                <div class="ewallet-notice" style="margin-top: 16px; padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; display: flex; align-items: flex-start; gap: 10px;">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="12" y1="16" x2="12" y2="12" />
                                        <line x1="12" y1="8" x2="12.01" y2="8" />
                                    </svg>
                                    <span style="font-size: 13px; color: #1e40af; line-height: 1.5;">You will be redirected to @selectedEWallet to complete your payment securely.</span>
                                </div>
                            }
                        </div>
                    }
                </div>
                @if (showValidation && string.IsNullOrWhiteSpace(orderDto.PaymentMethod))
                {
                    <span class="error-message">Please select a payment method</span>
                }
                @if (showValidation && orderDto.PaymentMethod == "e-wallet" && string.IsNullOrEmpty(selectedEWallet))
                {
                    <span class="error-message">Please select an e-wallet provider</span>
                }
                </div>

            <!-- Promo Code -->
            <div class="checkout-section">
                <div class="section-title">
                    <div class="title-icon">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                    </div>
                    <h2>Discount Code</h2>
                </div>
                <div class="promo-input-wrapper">
                    <input type="text" 
                           @bind="promoCode" 
                           placeholder="Enter promo code"
                           class="form-input promo-input" />
                    <button class="btn-apply-promo" @onclick="ApplyPromo">
                        @if (isApplyingPromo)
                        {
                            <span class="spinner"></span>
                        }
                        else
                        {
                            <span>Apply</span>
                        }
                    </button>
                </div>
                @if (!string.IsNullOrEmpty(promoMessage))
                {
                    <div class="promo-message @(promoSuccess ? "success" : "error")">
                        @promoMessage
                    </div>
                }
            </div>
        </div>

        <!-- Order Summary -->
        <div class="checkout-sidebar">
            <div class="order-summary">
                <h3>Order Summary</h3>
                
                <div class="summary-items">
                    @if (cartItems != null && cartItems.Any())
                    {
                        @foreach (var item in cartItems)
                        {
                            <div class="summary-item">
                                <img src="@item.ProductImage" alt="@item.ProductName" />
                                <div class="item-details">
                                    <div class="item-name">@item.ProductName</div>
                                    <div class="item-meta">Qty: @item.Quantity</div>
                                </div>
                                <div class="item-price">@((item.Price * item.Quantity).ToString("C"))</div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-cart">
                            <p>Your cart is empty</p>
                        </div>
                    }
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>@subtotal.ToString("C")</span>
                </div>
                
                @if (orderDto.DiscountAmount > 0)
                {
                    <div class="summary-row discount">
                        <span>Discount</span>
                        <span>-@orderDto.DiscountAmount?.ToString("C")</span>
                    </div>
                }

                <div class="summary-row">
                    <span>Shipping</span>
                    <span class="free">Free</span>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>Total</span>
                    <span>@orderDto.TotalAmount?.ToString("C")</span>
                </div>

                <button class="btn-place-order" @onclick="PlaceOrder" disabled="@isPlacingOrder">
                    @if (isPlacingOrder)
                    {
                        <span class="spinner"></span>
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>Place Order</span>
                    }
                </button>

                <div class="trust-badges">
                    <div class="badge">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                        </svg>
                        <span>Secure Checkout</span>
                    </div>
                    <div class="badge">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        </svg>
                        <span>Free Returns</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@if (isPlacingOrder)
{
    <div class="loading-overlay">
        Processing PayPal payment...
    </div>
}

<Toast @ref="ToastRef" />




